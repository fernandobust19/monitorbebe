<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receptor - Monitor Beb√©</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Google MediaPipe y TensorFlow.js optimizado -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∫ Receptor de Video</h1>
            <p>Visualizaci√≥n en vivo con Monitoreo IA</p>
            <button id="backBtn" class="btn-secondary">‚Üê Volver al inicio</button>
        </div>

        <!-- Panel de Configuraci√≥n de IA -->
        <div id="aiSettingsModal" class="ai-settings-modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ü§ñ Configuraci√≥n de Cuidado IA</h3>
                    <button onclick="closeAISettings()" class="modal-close">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="care-config-section">
                        <h4>üë• Cuidadores Autorizados</h4>
                        <p>Define qui√©nes pueden cuidar al beb√© sin generar alertas:</p>
                        <div class="caregiver-list">
                            <div class="caregiver-item">
                                <input type="text" id="caregiver1" placeholder="Nombre del cuidador 1 (ej: Mam√°)" class="caregiver-input">
                                <select class="caregiver-type">
                                    <option value="parent">Padre/Madre</option>
                                    <option value="family">Familiar</option>
                                    <option value="nurse">Ni√±era</option>
                                    <option value="visitor">Visitante</option>
                                </select>
                            </div>
                            <div class="caregiver-item">
                                <input type="text" id="caregiver2" placeholder="Nombre del cuidador 2 (ej: Pap√°)" class="caregiver-input">
                                <select class="caregiver-type">
                                    <option value="parent">Padre/Madre</option>
                                    <option value="family">Familiar</option>
                                    <option value="nurse">Ni√±era</option>
                                    <option value="visitor">Visitante</option>
                                </select>
                            </div>
                            <button onclick="addCaregiver()" class="btn-add-caregiver">‚ûï Agregar Cuidador</button>
                        </div>
                    </div>
                    
                    <div class="care-config-section">
                        <h4>üö™ Rutinas de Cuidado</h4>
                        <div class="routine-config">
                            <label>
                                <input type="checkbox" id="feedingTime"> üçº Horarios de alimentaci√≥n
                                <input type="time" id="feedingSchedule" class="time-input">
                            </label>
                            <label>
                                <input type="checkbox" id="sleepTime"> üò¥ Hora de dormir
                                <input type="time" id="sleepSchedule" class="time-input">
                            </label>
                            <label>
                                <input type="checkbox" id="playTime"> üß® Tiempo de juego
                                <input type="time" id="playSchedule" class="time-input">
                            </label>
                        </div>
                    </div>
                    
                    <div class="care-config-section">
                        <h4>‚ö†Ô∏è Sensibilidad de Alertas</h4>
                        <div class="sensitivity-config">
                            <label>Movimiento del beb√©:
                                <select id="movementSensitivity">
                                    <option value="low">Baja - Solo movimientos extremos</option>
                                    <option value="medium" selected>Media - Movimientos significativos</option>
                                    <option value="high">Alta - Cualquier movimiento</option>
                                </select>
                            </label>
                            <label>Personas desconocidas:
                                <select id="strangerSensitivity">
                                    <option value="low">Baja - Solo si se acercan mucho</option>
                                    <option value="medium" selected>Media - Personas cerca del beb√©</option>
                                    <option value="high">Alta - Cualquier persona en la habitaci√≥n</option>
                                </select>
                            </label>
                            <label>Objetos peligrosos:
                                <select id="objectSensitivity">
                                    <option value="low">Baja - Solo objetos muy peligrosos</option>
                                    <option value="medium" selected>Media - Objetos potencialmente peligrosos</option>
                                    <option value="high">Alta - Cualquier objeto no identificado</option>
                                </select>
                            </label>
                        </div>
                    </div>
                    
                    <div class="care-config-section">
                        <h4>üîî Tipos de Cuidado Especial</h4>
                        <div class="special-care">
                            <label><input type="checkbox" id="prematureBaby"> üëº Beb√© prematuro (mayor sensibilidad)</label>
                            <label><input type="checkbox" id="sickBaby"> ü§í Beb√© enfermo (monitoreo intensivo)</label>
                            <label><input type="checkbox" id="activeBaby"> üèÉ Beb√© muy activo (movimiento normal)</label>
                            <label><input type="checkbox" id="sleepyBaby"> üò¥ Beb√© que duerme mucho (menos alertas de quietud)</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button onclick="saveAISettings()" class="btn-save">üíæ Guardar Configuraci√≥n</button>
                    <button onclick="resetAISettings()" class="btn-reset">üîÑ Restaurar Predeterminado</button>
                    <button onclick="closeAISettings()" class="btn-cancel">Cancelar</button>
                </div>
            </div>
        </div>
        
        <!-- Panel de Estado de IA para Receptor -->
        <div id="aiStatusReceptor" class="ai-status-panel" style="display: none;">
            <h4>ü§ñ Monitor IA - Receptor</h4>
            <p>Recibiendo alertas del emisor...</p>
            <div style="margin: 10px 0;">
                <button id="testAlarmBtn" class="btn-secondary" style="margin-right: 10px;">üîä Probar Alarma</button>
                <button id="toggleSoundBtn" class="btn-secondary">üîá Silenciar Sonidos</button>
            </div>
            <div class="ai-stats">
                <div class="ai-stat">
                    <strong id="alertCountReceptor">0</strong>
                    <span>Alertas Recibidas</span>
                </div>
                <div class="ai-stat">
                    <strong id="lastAlertTimeReceptor">Nunca</strong>
                    <span>√öltima Alerta</span>
                </div>
            </div>
        </div>

        <div class="video-container">
            <div class="video-section full-width">
                <div class="video-header">
                    <h3>Transmisi√≥n Recibida</h3>
                    <div class="ai-controls-inline">
                        <button id="aiMonitorToggleReceptor" class="btn-ai-control" onclick="toggleAIFromReceptor()">ü§ñ Activar IA</button>
                        <button id="aiSettingsBtn" class="btn-ai-settings" onclick="openAISettings()">‚öôÔ∏è Configurar</button>
                    </div>
                </div>
                <video id="remoteVideo" 
                       autoplay 
                       playsinline 
                       muted 
                       controls 
                       webkit-playsinline
                       x5-video-player-type="h5"
                       x5-video-orientation="portrait"
                       style="width: 100%; max-height: 70vh; object-fit: contain;"></video>
                <div id="videoOverlay" class="video-overlay" style="display: none;">
                    <div class="play-button-container">
                        <svg class="play-icon" viewBox="0 0 200 200">
                            <polygon points="70, 55 70, 145 145, 100"></polygon>
                        </svg>
                        <span>Toca para Reproducir</span>
                    </div>
                </div>
                <div id="videoStatus" class="video-status">
                    <p>Estado: <span id="streamStatus">Esperando transmisi√≥n...</span></p>
                </div>
            </div>
        </div>

        <div class="connection-panel">
            <div class="room-info">
                <h3>Informaci√≥n de Conexi√≥n</h3>
                <p>ID de Sala: <span id="roomIdDisplay">No conectado</span></p>
                <p>Estado: <span id="connectionStatus">Desconectado</span></p>
                <p>Emisor: <span id="emisorStatus">Esperando...</span></p>
                <p>Receptores: <span id="receptorCount">-</span></p>
            </div>
            
            <div class="reception-controls">
                <button id="requestStreamBtn" class="btn-primary">üì° Solicitar Transmisi√≥n</button>                <button id="playVideoBtn" class="btn-primary" disabled>‚ñ∂Ô∏è Reproducir Video</button>                <button id="fullscreenBtn" class="btn-secondary" disabled>üî≤ Pantalla Completa</button>
                <button id="recordBtn" class="btn-info" disabled>üé• Grabar</button>
                <button id="diagnosticsBtn" class="btn-warning" onclick="runConnectionDiagnostics()">üîß Diagn√≥stico</button>
            </div>
        </div>

        <div class="audio-panel">
            <h3>Control de Audio</h3>
            <div class="audio-controls">
                <button id="muteBtn" class="btn-secondary">üîä Silenciar</button>
                <input type="range" id="volumeSlider" min="0" max="100" value="100" class="volume-slider">
                <span id="volumeDisplay">100%</span>
            </div>
        </div>

        <div class="quality-panel">
            <h3>Informaci√≥n de Calidad</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">Resoluci√≥n:</span>
                    <span id="resolution">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">FPS:</span>
                    <span id="fps">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Bitrate:</span>
                    <span id="bitrate">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Latencia:</span>
                    <span id="latency">-</span>
                </div>
            </div>
        </div>

        <div class="log-panel">
            <h3>Registro de Actividad</h3>
            <div id="logMessages" class="log-messages"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="js/webrtc-check.js"></script>
    <script src="js/alarm-sounds.js"></script>
    <script src="js/ai-baby-monitor-v2.js"></script>
    <script src="js/caregiver-detection.js"></script>
    <script src="js/receptor.js"></script>
</body>
</html>